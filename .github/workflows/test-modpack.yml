name: Test Modpack 1.21.1

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ручной запуск

jobs:
  test-modpack:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Чекаут кода
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Установка Java 21
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      # 3. Установка Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # 4. Установка зависимостей Python
      - name: Install Python dependencies
        run: pip install -r requirements.txt
      
      # 5. Скачивание модов
      - name: Download mods
        run: python scripts/download_mods.py
      
      # 6. Тестирование с MC-Runtime-Test (1.21.1 NeoForge)
      - name: Test Minecraft 1.21.1 NeoForge
        uses: headlesshq/mc-runtime-test@v1
        with:
          mc: '1.21.1'
          modloader: 'neoforge'
          modloader-version: 'latest'
          java: '21'
          timeout: '300'
        continue-on-error: true
      
      # 7. Анализ крашей через Perplexity
      - name: Analyze crashes with Perplexity
        if: failure()
        run: python scripts/analyze_crash.py
        env:
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
      
      # 8. Загрузка логов
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: minecraft-logs-1.21.1
          path: |
            logs/
            crash-reports/
          retention-days: 30
      
      # 9. Уведомление в Discord
      - name: Discord notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "Тест сборки 1.21.1 NeoForge"
          description: |
            **Версия:** Minecraft 1.21.1
            **Модлоадер:** NeoForge Latest
            **Статус:** ${{ job.status }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
          username: "Modpack CI"
